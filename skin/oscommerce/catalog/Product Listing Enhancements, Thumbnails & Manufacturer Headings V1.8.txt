Product Listing Enhancements, Thumbnails & Manufacturer Headings V1.8

This contribution is a much changed version of Product Thumbnail Listing that I started only a short while ago, but as thumbnails is now only one part I felt it should be a new contribution.

I was requested to make a contribution to Group Product Listing By Manufacturer with a manufacturer short description. This does exactly that based around the original product listing, so the old admin controls apply along with some new ones. 

The thumbnails part displays products with thumbnail images in a grid layout, you define how many boxes per line plus image & box sizes. It shows the product image etc in a box will, it obey the set order & items set in admin, so you can set the position order (vertically) of everything in the thumbnail (buy now buttons always below though). It also supports short description (if you have that). This also supports Additional Images (http://addons.oscommerce.com/info/1032) If you have this it will select the medium size image if it exists.  If the bottom row size is less than number products per row, it will be spaced seperately so spacing is even across the display & different to full rows. This feature is not used for grid display.

You can select block mode display in list/manufacturer listings similar to the 'new products' display. Thumbnail also has a pure 'grid' mode, there is same additional css for that.
You can also apply the thumbnail display to the new_products module & products_new page. NOTE: These files have an exrta date function, original will just list product to set limit, this adds a max age for product (default is 60days) to change edit the commented line. These files display  image, name, manufacturer & price only, they will not display any 'special price' as that may be illegal in your country.

As some of the listing styles remove the heading (you can select to remove in other modes too) where a user would select sort mode (if they realised, its not obvious) I`ve add a drop down to select sort order, that appears at the base of the product display, it will list according to what you have set in admin. Also added a drop down for user to select number of products shown per page.

The customer can switch between thumbnails & manufacturer if you set default to either provided you give the option. If you change default you must select a new category to reset your display.

If your store does'nt have manufacturers or your listing via search, the manufacturer mode will revert to list mode automatically.

There is now a pull down for sort order and a pull down for max results per page.

SETTINGS
New settings are added to admin under Product Listing, see below.

V1.1 Modified code if manufacture list is selected, but no manufacturers exist for category, the display will revert to standard listing rather than show blank display.
Changed files: product_listing.php, product_listing_setup.php

V1.2:
Added option of buy now & details button together on thumbnails page.
Added model option to thumbnails page..
Added extra image test for 'Additional Images'. 
Added standard style-able boxes, so you can set the style of the image boxes and the containing box. 
Incorporated  'easy graphic borders', so if you've installed that, it will use the set style. (http://addons.oscommerce.com/info/1702). 
Fixed the split page results for all displays.
Added missing install instruction (in index.php).
Changed files: product_listing.php, product_listing_setup.php css entries.

V1.2a minor bug, if there are no products to display thumbnail view borders were messed up. 
Changed files: product_listing.php

V1.3 
Modified Thumbnails routine, now it will obey the set order, so you can set the position order (vertically) of everything in the thumbnail (buy now buttons always below though)
Added manufacturer name,  quantity & weight options to the thumbnail.
Added admin option disable user style switch.
Added additional css for button positioning.
Added missing query for 'Additional Images'. 
Changed files: product_listing.php, product_listing_setup.php css entries.

V1.4
 Modified some of the code to make it more efficient (so smaller) so the code layout is somewhat modified. 
Added block display mode in list/manufacturer listings, similar to the 'new products' display, except you can choose whats shown & what order (Standard 'Product Listing' settings apply).
Added a  grid display option to the thumbnails display. 
Added extra picture test for 'Additional Images'.
Changed files: product_listing.php, product_listing_setup.php css entries.

V1.5
Removed debug code, if you have trouble use code from 1.4 to test.
Moved thumbnail function back into main block as a very few had a problem with it.
Added missing line to thumbnail for special prices.
Added modified new_products.php module with thumbnail option (only shows image, name & price).
Added modified products_new.php with thumbnail option (shows image, name, manufacturer & price) items shown & order as set in admin.
Changed files: product_listing.php, new_products.php, products_new.php

V1.5a
Fixed bug: In list modes, sort headings not active on page 1.
Removed some test script that got left in.
Changed files: product_listing.php

V1.5b
Minor Update, Added Category Name/Manufacturer Name to headings in thumbnail/list modes
Changed files: product_listing.php

V1.6
Added pull down for sort order
Added pull down for max results per page, values based on multiples of the 'Search Results' value in admin. For simplicity the 'Show All' just puts a figure of 1000000.
Changed files: product_listing.php plus modifications to index.php & manufacturers.php. See installation for details.

V1.7
Modified thumbnail to improve layout with varying amount of content, added 2 new settings to admin to achieve this, setting vertical space for image & name / description.
Modified code so sort &  max results drop down will appear at top or bottom of listing as per Prev/Next Navigation Bar. 
Slimmed some of the code to keep file size small.
Added sort option for products_new page.
Some have asked for category path in the product url, added an option on line 14 of product_listing.php change setting to 'true' if you want this
Minor bug fix, added manufacturer_id to products_new query so manufacturer link in that listing will work.
This update adds some new css for the thumbnail display.
Changed files: product_listing.php, new_products.php, products_new.php, product_listing_setup.php css entries.

V1.8
Made the contrib multilingual
Change to thumbnail display, if the bottom row size is less than number products per row, it will be spaced seperately so spacing is even across the display & different to full rows. This feature is not used for grid display.
Added some bug fixes related to SEO URL's (for application_top.php)
Changed files: product_listing.php, css entries, addition to includes/classes/boxes.php, includes/languages/english/index.php and includes/languages/english/advanced_search.php


If you wish to have the new_products.php module or products_new.php page showing thumbnails overwrite your existing files with the supplied (backup first). Note the new products_new.php page uses the new product_listing.php module, so you cant have the former without the later. In all cases if you select 'list' mode in admin the display will revert to the old style.

UPGRADING
If your upgading from any previous version, run the new setup file it will make any required changes (NOT REQUIRED from 1.7 to 1.8), replace all the changed files and add the new/changed css entries and modifications to includes/classes/boxes.php, includes/languages/english/index.php and includes/languages/english/advanced_search.php.
Additional instructions appear at the end of the install instructions.

During writing I cam accross some bugs in the core code details & fixes are at the bottom of the installation notes. There are some you must do if you use SEO URL's

SETTINGS:
Extra setting are added to admin:

Product Listing Style (default thumbnail )   			Use Thumbnail view, Manufacturer Listing or old List View. Also select 'Block' or 'Grid' mode.
Product Listing Short Description (default false )    		Show the 'Short Description' (if you have that).
Product Listing Manufacturers Description (default false )   		Show the 'Manufacturers Description'
Product Listing Image Width (default 140 )    			Product Image Width in listing.
Product Listing Box Width (default 200 )    			Set The Individual Product Listing Box Width
Product Listing Box Height (default 180 )    			Set The Individual Product Listing Box Height
Product Listing Price Size (default 3 )    			Set Product Listing Price Font Size
Product Listing Image Vertical Space (default 100)		Image Vertical Space in thumbnail, set to the height of largest product image.
Product Listing Name Vertical Space (default 25)		Name Vertical Space in thumbnail, sets vertical space for name & short description (if used).
Product Listing Per Row (default 2 )  			Set Number Of Products To List Per Row
Product Listing Buy Now / Details Button 			Display ‘Buy Now’, ‘Details’ Button or both or nothing
Product Listing Headings  (default true)			Display Listing Column Headings (setting false means user sort with drop down only).
Product Listing Style Switch  (default true)			Provide the user the option to switch listing style.

Additionally existing settings controling the display of Product Name, Image, Model, Quantity, Weight & Price Are Honored. The number of products shown per page is set by 'Search Results' in 'Maximum Values'.
The database query used is unchanged from the original, so order you set in admin etc will apply as before. The default sort for products_new.php is date added descending order.

The style of the display is controlled by a new entry in your css, you can set there if you wish a background image, colours, borders etc.

Page views are included in the package so you can see the result.

Short Description Contrib is at http://addons.oscommerce.com/info/3123
Easy graphic borders  Contrib is at http://addons.oscommerce.com/info/1702 
Additional Images is at http://addons.oscommerce.com/info/1032

Written on osC2.2 rc1 with PHP5 and has been tested on PHP 4 & 5, SQL 4 & 5, osC 2.2 ms2, rc1 & rc2a and is register_globals compatible.

Forum thread at :  http://forums.oscommerce.com/index.php?showtopic=307010

Installation is fairly easy.

Some people have had setup errors, so I`ve added a debug option, if you have any trouble, find at the start of product_listing.php 
$debug = 'no'; change this to $debug = 'yes'; then report the alert message in the forum.
Note: Removed from V1.4

First BACKUP BACKUP BACKUP

Copy the included replacement product_listing.php to includes/modules/
Copy the included product_listing_setup.php to admin/
Copy the included button_details.gif  and button_details_small.gif to includes/languages/english/images/buttons
Copy the included new_products.php  to includes/modules/ if you wish to use it.
Copy the included products_new.php to your catalog root if you wish to use it.
*******************************************

Open stylesheet.css

Add before the end:

.infoBoxProducts {
  text-align: center;
  border: solid 1px #999999; 
  font-family: Verdana, Arial, sans-serif;
  font-size: 10px;
  font-weight: normal;
  background-color: transparent;
  color: #333333;
  margin-bottom:-8px;
}
.infoBoxProducts a {
  color: #333333;
}
TD.infoBoxGrid {
  font-family: Verdana, Arial, sans-serif;
  font-size: 10px;
  border: solid 1px #999999;
}
/* set pos buy/details button on list */
img.buy_now {  
  margin-bottom:10px;
} 
/* set pos buy/details button on thumbnail */
img.thm_buy_now {
  margin-bottom:-3px;
} 
/* set style buy/details seperator thumbnail */
.buy_now {
  font-weight: bold;
	font-size: 18px;
	color: #999999;
} 
.infoBoxList {
 border: ridge 4px #faf0e6;
 border-collapse: collapse;
 background-color: #fff;
 }
.thumbcontent {
  font-family: Verdana, Arial, sans-serif;
  font-size: 10px;
  color:#666666;
  text-align:center;
}
TD.noborderbox {
  font-family: Verdana, Arial, sans-serif;
  font-size: 10px;
}
			
If you wish to use a background image, add to the .infoBoxProducts above:

  background-image: url(images/my-pic.gif);
  background-attachment: scroll;
  background-x-position: 0%;
  background-y-position: 0%;
  background-repeat: repeat-x;

& put the pic in your images directory.

If you use thumbnail grid mode you may find your borders need seperating, this needs a different technique between firefox & ie:

Find:
.infoBoxContents {
  background: #f8f8f9;
  font-family: Verdana, Arial, sans-serif;
  font-size: 10px;
}
Replace with:
.infoBoxContents {
  background: #f8f8f9;
  font-family: Verdana, Arial, sans-serif;
  font-size: 10px;
  border-spacing: 2px;
  border-collapse: separate;
  *border-collapse: expression('separate', cellSpacing = '2px');
}

If you use this with Easy Graphical Borders apply these changes too:

FIND:

TABLE.productListing {
  border: 1px;
  border-style: solid;
  border-color: #b6b7cb;
  border-spacing: 1px;
}

REPLACE WITH:

TABLE.productListing {
  border: 0px;
  border-style: solid;
  border-color: #b6b7cb;
  border-spacing: 0px;
}

FIND:
.productListing-heading {
  font-family: Verdana, Arial, sans-serif;
  font-size: 10px;
  background: #b6b7cb;
  color: #FFFFFF;
  font-weight: bold;
}

REPLACE WITH:

.productListing-heading{ 
   font-family: Verdana, Arial, sans-serif;
   font-size: 11px;
   font-weight: bold;
  color: #999999;
  vertical-align: middle;
  white-space: nowrap; 
}

*******************************************

Open index.php

Around 170 after:

       case 'PRODUCT_LIST_WEIGHT':
          $select_column_list .= 'p.products_weight, ';
          break;
      }
    }

 IF YOU HAVE THE SHORT DESCIPTION MOD ADD:

$select_column_list .= 'pd.short_desc, ';

Around 252 find:

        echo tep_draw_hidden_field('sort', $HTTP_GET_VARS['sort']);

replace with:

        echo tep_draw_hidden_field('sort', $_GET['sort']).(isset($_GET['list']) ? tep_draw_hidden_field('list', $_GET['list']) : '') . (isset($_GET['max']) ? tep_draw_hidden_field('max', $_GET['max']) : '');

Note there is also a bug fix for this file below.

*******************************************
Open includes/languages/english/index.php

Before the final ?>

Add:

define('TABLE_HEADING_DETAIL', 'Click For More');
define('TEXT_POA', ' P.O.A');
define('IMAGE_BUTTON_DETAILS', 'Product Details'); 
define('NUM_ORDER', ', Low to High');
define('APHA_ORDER', '');
define('REVERSE_ALPHA_ORDER', ', Reverse');
define('REVERSE_NUM_ORDER', ', High to Low');
define('DATE_ORDER', 'Date Added');
define('LIST_VIEW', 'List View');
define('THUMB_VIEW', 'Thumbnail View');
define('WEIGHT_ABRV', 'Kg');
*******************************************
Open includes/languages/english/advanced_search.php

Before the final ?>

Add:

define('TABLE_HEADING_DETAIL', 'Click For More');
define('TEXT_POA', ' P.O.A');
define('IMAGE_BUTTON_DETAILS', 'Product Details'); 
define('NUM_ORDER', ', Low to High');
define('APHA_ORDER', '');
define('REVERSE_ALPHA_ORDER', ', Reverse');
define('REVERSE_NUM_ORDER', ', High to Low');
define('DATE_ORDER', 'Date Added');
define('LIST_VIEW', 'List View');
define('THUMB_VIEW', 'Thumbnail View');
define('WEIGHT_ABRV', 'Kg');
*******************************************
Open includes/boxes/manufacturers.php

Find: (52)

 $info_box_contents[] = array('form' => tep_draw_form('manufacturers', tep_href_link(FILENAME_DEFAULT, '', 'NONSSL', false), 'get'),
                                   'text' => tep_draw_pull_down_menu('manufacturers_id', $manufacturers_array, (isset($HTTP_GET_VARS['manufacturers_id']) ? $HTTP_GET_VARS['manufacturers_id'] : ''), 'onChange="this.form.submit();" size="' . MAX_MANUFACTURERS_LIST . '" style="width: 100%"') . tep_hide_session_id());

Repace with:

      $info_box_contents[] = array('form' => tep_draw_form('manufacturers', tep_href_link(FILENAME_DEFAULT, '', 'NONSSL', false), 'get'),
                                   'text' => (isset($_GET['sort']) ? tep_draw_hidden_field('sort', $_GET['sort']) : '') . (isset($_GET['list']) ? tep_draw_hidden_field('list', $_GET['list']) : '') . (isset($_GET['max']) ? tep_draw_hidden_field('max', $_GET['max']) : '') . tep_draw_pull_down_menu('manufacturers_id', $manufacturers_array, (isset($HTTP_GET_VARS['manufacturers_id']) ? $HTTP_GET_VARS['manufacturers_id'] : ''), 'onChange="this.form.submit();" size="' . MAX_MANUFACTURERS_LIST . '" style="width: 100%"') . tep_hide_session_id());

*******************************************
DO THESE CHANGES ONLY IF YOU DON'T HAVE GRAPHIC BORDERS ALREADY INSTALLED

Open includes/classes/boxes.php

Add before the final ?>

class noborderBox extends tableBox {
  function noborderBox($contents) {
	$this->table_cellpadding = '0';
	$this->table_cellspacing = '3';
	$this->table_data_parameters = 'class="noborderBox"';
	$this->tableBox($contents, true);
   }
 }

*******************************************
DO THESE CHANGES ONLY IF YOU WISH TO ADD MANUFACTURER DESCRIPTIONS

Open admin/manufacturers.php

Find near 45

      for ($i=0, $n=sizeof($languages); $i<$n; $i++) {
          $manufacturers_url_array = $HTTP_POST_VARS['manufacturers_url'];
          $language_id = $languages[$i]['id'];

          $sql_data_array = array('manufacturers_url' => tep_db_prepare_input($manufacturers_url_array[$language_id]));

Replace With:

       for ($i=0, $n=sizeof($languages); $i<$n; $i++) {
          $language_id = $languages[$i]['id'];
          $sql_data_array = array('manufacturers_url' => tep_db_prepare_input($_POST['manufacturers_url'][$language_id]),
		            'manufacturers_description' => tep_db_prepare_input($_POST['manufacturers_description'][$language_id]));

Find near 197

     $manufacturer_inputs_string = '';
      $languages = tep_get_languages();

Add After:

     for ($i=0, $n=sizeof($languages); $i<$n; $i++) {
     $manufacturer_inputs_string .= '<br>' . tep_image(DIR_WS_CATALOG_LANGUAGES . $languages[$i]['directory'] . '/images/' . $languages[$i]['image'], $languages[$i]['name']) . '&nbsp;' . tep_draw_input_field('manufacturers_description[' . $languages[$i]['id'] . ']', tep_get_manufacturer_description($mInfo->manufacturers_id, $languages[$i]['id']),'size="50" maxlength="64"');
      }
      $contents[] = array('text' => '<br>' . TEXT_MANUFACTURERS_DESCRIPTION . $manufacturer_inputs_string);$manufacturer_inputs_string = '';

Find near 220

      $manufacturer_inputs_string = '';
      $languages = tep_get_languages();

Add after:

      for ($i=0, $n=sizeof($languages); $i<$n; $i++) {
     $manufacturer_inputs_string .= '<br>' . tep_image(DIR_WS_CATALOG_LANGUAGES . $languages[$i]['directory'] . '/images/' . $languages[$i]['image'], $languages[$i]['name']) . '&nbsp;' . tep_draw_input_field('manufacturers_description[' . $languages[$i]['id'] . ']', tep_get_manufacturer_description($mInfo->manufacturers_id, $languages[$i]['id']),'size="50" maxlength="64"');
      }
     $contents[] = array('text' => '<br>' . TEXT_MANUFACTURERS_DESCRIPTION . $manufacturer_inputs_string);$manufacturer_inputs_string = '';

Note there is also a bug fix for this file below.

*******************************************

Open admin/includes/languages/english/manufacturers.php

Before the final ?>

Add:
 
define('TEXT_MANUFACTURERS_DESCRIPTION', 'Manufacturers Description:');

*******************************************

Open admin/includes/functions/general.php

Find near 525

////
// Return the manufacturers URL in the needed language

Add Before:

	
////
// Return the manufacturers description in the needed language
// TABLES: manufacturers_info
  function tep_get_manufacturer_description($manufacturer_id, $language_id) {
    $manufacturer_query = tep_db_query("select manufacturers_description from " . TABLE_MANUFACTURERS_INFO . " where manufacturers_id = '" . (int)$manufacturer_id . "' and languages_id = '" . (int)$language_id . "'");
    $manufacturer = tep_db_fetch_array($manufacturer_query);

    return $manufacturer['manufacturers_description'];
  }

END OF  MANUFACTURER DESCRIPTIONS MOD

*******************************************

Log in to your admin, then goto the setup page by pasting into the url something like www.mysite.com/catalog/admin/product_listing_setup.php
If you have ssl you may need to preface with https ie:  https//www.mysite.com/catalog/admin/product_listing_setup.php

It will add the settings to the database, to alter go to configuration/product Listing.
If you have already installed an ealier version the setup will upgrade your install, it states at each stage what it finds.

A messaage will be displayed to confirm setup within a normal admin screen.

Delete the product_listing_setup.php from admin once setup is finished.

Thats it, your done!!

*******************************************

If your using 'Graphic borders' There are some changes to make on line 12 of  product_listing.php. Its commented.

*******************************************

Found and fixed some bugs:

1.  If customer selects a manufacturer from left colomn drop down, then attemps to go to all manufacturers by selecting 'please select' a blank page is shown

to fix, at top of index.php after : 
require('includes/application_top.php');
add:
// fix manufacture reset bug
if (isset($_GET['manufacturers_id']) && !tep_not_null($_GET['manufacturers_id'])) { tep_redirect(tep_href_link(FILENAME_DEFAULT));}   

2. If you edit a manufacturer in admin without changing the picture, the image will be deleted from the database.

to fix, in manufacturers.php find near 40: 

 if ($manufacturers_image = new upload('manufacturers_image', DIR_FS_CATALOG_IMAGES)) {
     tep_db_query("update " . TABLE_MANUFACTURERS . " set manufacturers_image = '" . $manufacturers_image->filename . "' where manufacturers_id = '" . (int)$manufacturers_id . "'");        } 

replace with:

$manufacturers_image = new upload('manufacturers_image');
$manufacturers_image->set_destination(DIR_FS_CATALOG_IMAGES);
if ($manufacturers_image->parse() && $manufacturers_image->save()) {
    tep_db_query("update " . TABLE_MANUFACTURERS . " set manufacturers_image = '" . tep_db_input($manufacturers_image->filename) . "' where manufacturers_id = '" . (int)$manufacturers_id . "'");
        }

3. If  search engine friendly url is set to 'on' you can get a 'Unable to determine the page link' error, this is because $PHP_SELF can  become a null value as due to the altered search engine friendly url causing $HTTP_SERVER_VARS['PHP_SELF'] to give the same result as getenv('PATH_INFO') and the search engine friendly urls function removes getenv('PATH_INFO') from $PHP_SELF so $PHP_SELF = NULL hence error.

To fix, in application_top.php 
find (94)
$PHP_SELF = str_replace(getenv('PATH_INFO'), '', $PHP_SELF);
add after:
if (($PHP_SELF == '') || (strlen(trim($PHP_SELF)) == 0)) $PHP_SELF = rtrim(str_replace(array( getenv('PATH_INFO'),getenv('QUERY_STRING')) , '', $_SERVER['REQUEST_URI']), '?');

4. An additional issue with search engine friendly url is set to 'on' is some or all of the $_GET not being set.

To fix, in application_top.php

find (96)

      $vars = explode('/', substr(getenv('PATH_INFO'), 1));

add after:

    if (PHP_VERSION >= 4.1) $HTTP_GET_VARS =& $_GET;


*******************************************